<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ‰‹åŠ¿åˆ‡æ°´æœ - è¿›é˜¶ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #1a1a1a; /* æ·±è‰²èƒŒæ™¯ */
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      user-select: none;
    }

    /* æ¸¸æˆä¸»å®¹å™¨ */
    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: radial-gradient(circle, #2c3e50 0%, #000000 100%);
    }

    .input_video {
      position: absolute;
      top: 0;
      left: 0;
      width: 160px; /* ç¼©å°æ˜¾ç¤º */
      height: 120px;
      opacity: 0.5;
      z-index: 1;
      transform: scaleX(-1);
      border-bottom-right-radius: 10px;
      border: 2px solid rgba(255,255,255,0.2);
    }

    .output_canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 2;
      transform: scaleX(-1); /* ç”»å¸ƒé•œåƒï¼Œè®©æ“ä½œç¬¦åˆç›´è§‰ */
    }

    /* æ¸¸æˆå†… HUD (åˆ†æ•°/æ—¶é—´) - ä¸ä¼šè¢«é•œåƒ */
    #hud-layer {
      position: absolute;
      top: 20px;
      right: 30px;
      z-index: 10;
      color: white;
      text-align: right;
      pointer-events: none;
      display: none; /* åˆå§‹éšè— */
    }

    .hud-item {
      margin-bottom: 15px;
    }
    .hud-label {
      font-size: 14px;
      color: #ccc;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .hud-value {
      font-size: 42px;
      font-weight: 800;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      font-family: 'Courier New', Courier, monospace;
    }
    #timer-val.warning { color: #ff4757; text-shadow: 0 0 15px #ff4757; }

    /* å…¨å±èœå•é®ç½© (å¼€å§‹/ç»“æŸ) */
    .menu-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: 20;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      backdrop-filter: blur(5px);
    }

    .hidden { display: none !important; }

    h1 { font-size: 60px; margin: 0 0 20px 0; text-shadow: 0 0 20px #e67e22; color: #f39c12; }
    h2 { font-size: 40px; margin: 0 0 20px 0; color: #e74c3c; }
    
    .btn {
      padding: 15px 40px;
      font-size: 24px;
      background: linear-gradient(45deg, #e67e22, #d35400);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s;
      box-shadow: 0 5px 15px rgba(230, 126, 34, 0.4);
      font-weight: bold;
    }
    .btn:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(230, 126, 34, 0.6); }
    .btn:active { transform: scale(0.95); }

    .score-board {
      font-size: 24px;
      margin-bottom: 30px;
      text-align: center;
      line-height: 1.5;
    }
    .highlight { color: #f1c40f; font-size: 32px; font-weight: bold; }

  </style>
</head>
<body>

<div id="game-container">
  <video class="input_video"></video>
  <canvas class="output_canvas"></canvas>
  
  <!-- æ¸¸æˆå†… HUD -->
  <div id="hud-layer">
    <div class="hud-item">
      <div class="hud-label">Time</div>
      <div class="hud-value" id="timer-val">60</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Score</div>
      <div class="hud-value" id="score-val">0</div>
    </div>
  </div>

  <!-- å¼€å§‹èœå• -->
  <div id="start-screen" class="menu-overlay">
    <h1>ğŸ å¿è€…åˆ‡æ°´æœ ğŸ‰</h1>
    <p style="font-size: 18px; opacity: 0.8; margin-bottom: 40px;">
      ç§»åŠ¨é£ŸæŒ‡æŒ‡å°–åˆ‡å¼€æ°´æœï¼Œå°å¿ƒç‚¸å¼¹ï¼ğŸ’£
    </p>
    <button class="btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
  </div>

  <!-- ç»“æŸèœå• -->
  <div id="game-over-screen" class="menu-overlay hidden">
    <h2>æ¸¸æˆç»“æŸ</h2>
    <div class="score-board">
      <div>æœ€ç»ˆå¾—åˆ†</div>
      <div class="highlight" id="final-score">0</div>
    </div>
    <div id="game-over-reason" style="color: #ff6b6b; margin-bottom: 20px;">æ—¶é—´è€—å°½</div>
    <button class="btn" onclick="startGame()">å†æ¥ä¸€å±€</button>
  </div>
</div>

<script>
  // --- 1. ç³»ç»Ÿå˜é‡ & é…ç½® ---
  const videoElement = document.getElementsByClassName('input_video')[0];
  const canvasElement = document.getElementsByClassName('output_canvas')[0];
  const canvasCtx = canvasElement.getContext('2d');
  
  // UI å…ƒç´ 
  const hudLayer = document.getElementById('hud-layer');
  const startScreen = document.getElementById('start-screen');
  const gameOverScreen = document.getElementById('game-over-screen');
  const scoreEl = document.getElementById('score-val');
  const timerEl = document.getElementById('timer-val');
  const finalScoreEl = document.getElementById('final-score');
  const reasonEl = document.getElementById('game-over-reason');

  // æ¸¸æˆçŠ¶æ€
  let gameState = 'MENU'; // MENU, PLAYING, GAMEOVER
  let score = 0;
  let timeLeft = 60;
  let timerInterval = null;
  let handPosition = { x: -1, y: -1 };
  
  // ç‰©ç†å¯¹è±¡æ•°ç»„
  let fruits = [];
  let particles = []; // åˆ‡å¼€çš„ç¢ç‰‡
  let lastSpawnTime = 0;
  
  // å®šä¹‰æ°´æœç±»å‹
  const FRUIT_TYPES = [
    { icon: 'ğŸ', color: '#ff4757', size: 50 },
    { icon: 'ğŸŠ', color: '#ffa502', size: 45 },
    { icon: 'ğŸ‰', color: '#2ed573', size: 60 },
    { icon: 'ğŸ¥', color: '#7bed9f', size: 45 },
    { icon: 'ğŸ¥¥', color: '#dfe4ea', size: 50 },
  ];
  const BOMB_TYPE = { icon: 'ğŸ’£', color: '#2f3542', size: 60, type: 'bomb' };

  // é‡åŠ›å¸¸é‡
  const GRAVITY = 0.25;

  // --- 2. MediaPipe è®¾ç½® ---
  const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });

  hands.onResults(onHandResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => { await hands.send({image: videoElement}); },
    width: 1280, height: 720
  });
  camera.start();

  // --- 3. æ ¸å¿ƒé€»è¾‘ ---

  function onHandResults(results) {
    // é€‚é…ç”»å¸ƒ
    canvasElement.width = window.innerWidth;
    canvasElement.height = window.innerHeight;
    const W = canvasElement.width;
    const H = canvasElement.height;

    canvasCtx.save();
    canvasCtx.clearRect(0, 0, W, H);

    // 3.1 è¿½è¸ªæ‰‹åŠ¿
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      const landmarks = results.multiHandLandmarks[0];
      const indexTip = landmarks[8]; // é£ŸæŒ‡æŒ‡å°–
      
      handPosition = { x: indexTip.x * W, y: indexTip.y * H };

      // ç»˜åˆ¶åˆ€å…‰/è½¨è¿¹ (é»„è‰²å…‰æ™•)
      canvasCtx.shadowBlur = 20;
      canvasCtx.shadowColor = "gold";
      canvasCtx.fillStyle = "rgba(255, 255, 255, 0.9)";
      canvasCtx.beginPath();
      canvasCtx.arc(handPosition.x, handPosition.y, 10, 0, 2 * Math.PI);
      canvasCtx.fill();
      canvasCtx.shadowBlur = 0;
    } else {
      handPosition = { x: -1000, y: -1000 }; // ç§»å‡ºå±å¹•
    }

    // 3.2 åªæœ‰åœ¨æ¸¸æˆä¸­æ‰è¿è¡Œç‰©ç†å¾ªç¯
    if (gameState === 'PLAYING') {
      updateAndDrawGame(W, H);
    } else if (gameState === 'GAMEOVER') {
        // æ¸¸æˆç»“æŸä¹Ÿå¯ä»¥è®©ç¢ç‰‡æ‰å®Œï¼Œæ˜¾å¾—è‡ªç„¶ç‚¹
        updateParticles(W, H);
    }

    canvasCtx.restore();
  }

  function startGame() {
    // é‡ç½®æ•°æ®
    score = 0;
    timeLeft = 60;
    fruits = [];
    particles = [];
    gameState = 'PLAYING';
    
    // UI æ›´æ–°
    startScreen.classList.add('hidden');
    gameOverScreen.classList.add('hidden');
    hudLayer.style.display = 'block';
    scoreEl.innerText = score;
    timerEl.innerText = timeLeft;
    timerEl.classList.remove('warning');

    // å¯åŠ¨å€’è®¡æ—¶
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timeLeft--;
      timerEl.innerText = timeLeft;
      if (timeLeft <= 10) timerEl.classList.add('warning');
      
      if (timeLeft <= 0) {
        endGame("æ—¶é—´è€—å°½!");
      }
    }, 1000);
  }

  function endGame(reason) {
    gameState = 'GAMEOVER';
    clearInterval(timerInterval);
    
    hudLayer.style.display = 'none';
    gameOverScreen.classList.remove('hidden');
    finalScoreEl.innerText = score;
    reasonEl.innerText = reason;
  }

  function updateAndDrawGame(W, H) {
    const now = Date.now();

    // 1. ç”Ÿæˆæ°´æœ (åŠ¨æ€éš¾åº¦ï¼šåˆ†æ•°è¶Šé«˜ï¼Œç”Ÿæˆè¶Šå¿«)
    let interval = 1000 - Math.min(score * 5, 600); // æœ€å¿« 400ms
    if (now - lastSpawnTime > interval) {
      spawnObject(W, H);
      lastSpawnTime = now;
    }

    // 2. æ›´æ–°æ°´æœ
    for (let i = fruits.length - 1; i >= 0; i--) {
      let f = fruits[i];
      
      // ç‰©ç†è¿åŠ¨
      f.x += f.vx;
      f.y += f.vy;
      f.vy += GRAVITY; // é‡åŠ›
      f.rotation += f.rotationSpeed;

      // ç»˜åˆ¶
      drawFruit(f);

      // æ£€æµ‹ç¢°æ’ (è·ç¦»æ£€æµ‹)
      const dist = Math.hypot(f.x - handPosition.x, f.y - handPosition.y);
      if (dist < f.size) {
        // åˆ‡åˆ°äº†ï¼
        if (f.type === 'bomb') {
          endGame("åˆ‡åˆ°äº†ç‚¸å¼¹! ğŸ’¥");
          return;
        } else {
          // æ°´æœ
          score += 10;
          scoreEl.innerText = score;
          createSliceEffect(f); // åˆ‡å¼€ç‰¹æ•ˆ
          fruits.splice(i, 1); // ç§»é™¤æ°´æœ
          continue;
        }
      }

      // æ‰å‡ºå±å¹•ç§»é™¤
      if (f.y > H + 100) {
        fruits.splice(i, 1);
      }
    }

    // 3. æ›´æ–°ç¢ç‰‡
    updateParticles(W, H);
  }

  function updateParticles(W, H) {
    for (let i = particles.length - 1; i >= 0; i--) {
      let p = particles[i];
      p.x += p.vx;
      p.y += p.vy;
      p.vy += GRAVITY + 0.1; // ç¢ç‰‡é‡åŠ›ç¨å¾®å¤§ä¸€ç‚¹
      p.rotation += p.rotationSpeed;
      p.life--; // ç”Ÿå‘½å‘¨æœŸ

      // ç»˜åˆ¶åŠä¸ªæ°´æœ
      drawHalfFruit(p);

      if (p.life <= 0 || p.y > H) {
        particles.splice(i, 1);
      }
    }
  }

  function spawnObject(W, H) {
    // 20% æ¦‚ç‡æ˜¯ç‚¸å¼¹
    const isBomb = Math.random() < 0.2;
    const item = isBomb ? BOMB_TYPE : FRUIT_TYPES[Math.floor(Math.random() * FRUIT_TYPES.length)];

    // éšæœºèµ·å§‹ä½ç½® (åº•éƒ¨ä¸­é—´åŒºåŸŸ)
    const startX = W * 0.2 + Math.random() * (W * 0.6);
    const startY = H + 50;

    // å‘ä¸­å¿ƒåä¸Šçš„éšæœºé€Ÿåº¦
    const targetX = W * 0.2 + Math.random() * (W * 0.6);
    const vx = (targetX - startX) / 100; // ç®€å•çš„æ°´å¹³é€Ÿåº¦å¼•å¯¼
    const vy = -(12 + Math.random() * 5); // å¼ºåŠ›çš„å‘ä¸Šè„‰å†²

    fruits.push({
      ...item, // å¤åˆ¶å±æ€§ (icon, color, size)
      x: startX,
      y: startY,
      vx: vx,
      vy: vy,
      rotation: Math.random() * Math.PI,
      rotationSpeed: (Math.random() - 0.5) * 0.2,
      type: isBomb ? 'bomb' : 'fruit'
    });
  }

  // ç»˜åˆ¶å®Œæ•´æ°´æœ
  function drawFruit(f) {
    canvasCtx.save();
    canvasCtx.translate(f.x, f.y);
    canvasCtx.rotate(f.rotation);
    
    // ç»˜åˆ¶ Emoji
    canvasCtx.font = `${f.size * 2}px Arial`;
    canvasCtx.textAlign = "center";
    canvasCtx.textBaseline = "middle";
    canvasCtx.fillText(f.icon, 0, 8); // å¾®è°ƒ y è½´å±…ä¸­
    
    canvasCtx.restore();
  }

  // ç”Ÿæˆåˆ‡å¼€çš„ç¢ç‰‡
  function createSliceEffect(f) {
    // ç”Ÿæˆå·¦å³ä¸¤ç‰‡
    // å·¦ç‰‡
    particles.push({
      icon: f.icon, size: f.size,
      x: f.x, y: f.y,
      vx: f.vx - 2 - Math.random(), // å‘å·¦ç‚¸å¼€
      vy: f.vy - 2,
      rotation: f.rotation,
      rotationSpeed: -0.1 - Math.random() * 0.1,
      life: 60,
      side: 'left'
    });
    // å³ç‰‡
    particles.push({
      icon: f.icon, size: f.size,
      x: f.x, y: f.y,
      vx: f.vx + 2 + Math.random(), // å‘å³ç‚¸å¼€
      vy: f.vy - 2,
      rotation: f.rotation,
      rotationSpeed: 0.1 + Math.random() * 0.1,
      life: 60,
      side: 'right'
    });
  }

  // ç»˜åˆ¶åŠä¸ªæ°´æœ (ä½¿ç”¨ clip å®ç°)
  function drawHalfFruit(p) {
    canvasCtx.save();
    canvasCtx.translate(p.x, p.y);
    canvasCtx.rotate(p.rotation);
    
    // é€æ˜åº¦æ¸å˜
    canvasCtx.globalAlpha = p.life / 60;

    // åˆ›å»ºè£å‰ªåŒºåŸŸ
    canvasCtx.beginPath();
    if (p.side === 'left') {
        // è£å·¦è¾¹ï¼šç”»ä¸€ä¸ªå·¦åŠè¾¹çš„çŸ©å½¢
        canvasCtx.rect(-p.size, -p.size, p.size, p.size * 2);
    } else {
        // è£å³è¾¹
        canvasCtx.rect(0, -p.size, p.size, p.size * 2);
    }
    canvasCtx.clip();

    // ç»˜åˆ¶å®Œæ•´çš„ Emoji (ç”±äºè¢« clip äº†ï¼Œåªä¼šæ˜¾ç¤ºä¸€åŠ)
    canvasCtx.font = `${p.size * 2}px Arial`;
    canvasCtx.textAlign = "center";
    canvasCtx.textBaseline = "middle";
    canvasCtx.fillText(p.icon, 0, 8);

    canvasCtx.restore();
  }

</script>
</body>
</html>